services:
  mongodb:
    image: mongo:7
    restart: unless-stopped
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USERNAME:-admin}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD:-secret}
    volumes:
      - mongo-data:/data/db

  backend:
    image: ghcr.io/duelidave/gains-backend:latest
    build:
      context: ./backend
    restart: unless-stopped
    ports:
      - "${PORT:-4000}:4000"
    environment:
      - PORT=4000
      - MONGO_URI=${MONGO_URI:-mongodb://admin:secret@mongodb:27017/fitness?authSource=admin}
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3000}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - AUTH_PROVIDER=${AUTH_PROVIDER:-local}
      - JWT_SECRET=${JWT_SECRET:-dev-only-change-me-in-production}
      - ALLOW_REGISTRATION=${ALLOW_REGISTRATION:-true}
      - KEYCLOAK_URL=${KEYCLOAK_URL:-}
      - KEYCLOAK_REALM=${KEYCLOAK_REALM:-}
      - KEYCLOAK_CLIENT_ID=${KEYCLOAK_CLIENT_ID:-}
      - KEYCLOAK_PUBLIC_URL=${KEYCLOAK_PUBLIC_URL:-}
      - OIDC_ISSUER_URL=${OIDC_ISSUER_URL:-}
      - OIDC_CLIENT_ID=${OIDC_CLIENT_ID:-}
      - OIDC_CLIENT_SECRET=${OIDC_CLIENT_SECRET:-}
      - OIDC_SCOPES=${OIDC_SCOPES:-openid profile email}
    depends_on:
      - mongodb

  frontend:
    image: ghcr.io/duelidave/gains-frontend:latest
    build:
      context: ./frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    depends_on:
      - backend

volumes:
  mongo-data:
